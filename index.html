<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcher Song ist das?</title>
    <style>
        body{font-family:Arial;text-align:center;background:#f0f8ff;padding:20px;}
        h1{color:#ff69b4;}
        input,button,select{padding:12px;font-size:18px;margin:8px;border-radius:10px;}
        button{background:#ff69b4;color:white;border:none;cursor:pointer;}
        button:hover{background:#ff1493;}
        #player-container{position:relative;width:90%;max-width:600px;height:350px;margin:20px auto;border:5px solid #ff69b4;border-radius:15px;overflow:hidden;background:#000;}
        #player{width:100%;height:480px !important;margin-top:-80px;pointer-events:none;}
        #black-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:black;z-index:10;}
        .hide{display:none;}
        #feedback{font-size:24px;margin:20px;min-height:60px;}
    </style>
</head>
<body>
    <h1>Welcher Song ist das?</h1>
    <p>Schreib einen Künstler rein und rate!</p>
    <input type="text" id="artistInput" placeholder="z.B. Gzuz, Bonez MC...">
    <select id="difficulty">
        <option value="5">5 Sekunden (hart)</option>
        <option value="10" selected>10 Sekunden (normal)</option>
        <option value="20">20 Sekunden (easy)</option>
    </select>
    <button id="startButton">Los geht’s!</button>

    <div id="quizArea" class="hide">
        <p>Hör genau hin!</p>
        <div id="player-container">
            <div id="player"></div>
            <div id="black-overlay"></div>
        </div>
        <br>
        <input type="text" id="guessInput" placeholder="Songtitel eingeben">
        <button id="guessButton">Raten!</button>
        <br>
        <button id="repeatAudio" class="hide">Nochmal hören (nur Ton)</button>
        <button id="repeatVideo" class="hide">Mit Video hören</button>
        <button id="giveUp" class="hide">Aufgeben & alles zeigen</button>
        <button id="nextButton" class="hide">Nächster Song</button>
        <p id="feedback"></p>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player, currentTitle = "", videoId = "", startSec = 0, snippetLen = 10, currentArtist = "";
        let timeoutId = null;
        const overlay = document.getElementById("black-overlay");
        const proxy = "https://corsproxy.io/?";

        async function sucheVideo(artist) {
            const queries = ["official music video", "offizielles video", "music video", "vevo", "topic"];
            for (let term of queries) {
                try {
                    const q = `${artist} ${term}`;
                    const url = proxy + encodeURIComponent("https://www.youtube.com/results?search_query=" + encodeURIComponent(q));
                    const resp = await fetch(url);
                    const html = await resp.text();
                    const ids = [...html.matchAll(/watch\?v=([a-zA-Z0-9_-]{11})/g)].map(m => m[1]).slice(0,20);
                    if (ids.length === 0) continue;

                    videoId = ids[Math.floor(Math.random() * ids.length)];
                    const titleMatch = html.match(new RegExp(`"videoId":"${videoId}".*?"text":"([^"]+)"`));
                    let raw = titleMatch ? titleMatch[1] : "Song";
                    currentTitle = raw.split(/[-|–—:]/).pop().replace(/\s*\(.*?\)|\s*\[.*?\]|official.{0,30}video|music video|lyrics|vevo|topic|feat.*|ft.*/gi,"").trim();
                    if (currentTitle.length > 3) return;
                } catch(e) {}
            }
            throw "Kein Video";
        }

        function playSnippet(onlyAudio = false) {
            if (timeoutId) clearTimeout(timeoutId);

            overlay.style.display = onlyAudio ? 'block' : 'none';

            player.loadVideoById({
                videoId: videoId,
                startSeconds: startSec,
                playerVars: { controls:0, showinfo:0, modestbranding:1, fs:0, rel:0, iv_load_policy:3, autoplay:1 }
            });
            player.playVideo();

            // NUR bei "nur Ton" → Timer setzen
            if (onlyAudio) {
                timeoutId = setTimeout(() => {
                    player.pauseVideo();
                    overlay.style.display = 'block';
                    timeoutId = null;
                }, snippetLen * 1000);
            }
        }

        async function neueRunde() {
            document.getElementById("feedback").textContent = "Lade Song...";
            document.querySelectorAll("#repeatAudio,#repeatVideo,#giveUp,#nextButton").forEach(b => b.classList.add("hide"));
            document.getElementById("guessInput").value = "";

            try {
                await sucheVideo(currentArtist);
                startSec = Math.floor(Math.random() * 140) + 15;
                playSnippet(true);  // erste Runde immer nur Ton
                document.getElementById("feedback").textContent = "Hör genau hin!";
            } catch {
                document.getElementById("feedback").textContent = "Kein Video – nochmal Los geht’s!";
            }
        }

        document.getElementById("startButton").onclick = () => {
            currentArtist = document.getElementById("artistInput").value.trim();
            if (!currentArtist) return alert("Künstler eingeben!");
            snippetLen = parseInt(document.getElementById("difficulty").value);
            document.getElementById("quizArea").classList.remove("hide");
            player = new YT.Player('player', { events: { onReady: neueRunde }});
        };

        document.getElementById("guessButton").onclick = () => {
            const guess = document.getElementById("guessInput").value.toLowerCase().trim();
            if (currentTitle.toLowerCase().includes(guess)) {
                if (timeoutId) clearTimeout(timeoutId);
                overlay.style.display = 'none';
                player.playVideo();
                document.getElementById("feedback").innerHTML = `RICHTIG! Es war:<br><b>${currentTitle}</b>`;
                document.getElementById("nextButton").classList.remove("hide");
                document.querySelectorAll("#repeatAudio,#repeatVideo,#giveUp").forEach(b => b.classList.add("hide"));
            } else {
                document.getElementById("feedback").textContent = "Leider falsch – nochmal versuchen?";
                document.getElementById("repeatAudio").classList.remove("hide");
                document.getElementById("repeatVideo").classList.remove("hide");
                document.getElementById("giveUp").classList.remove("hide");
                document.getElementById("guessInput").value = "";
            }
        };

        // NUR TON → kurz
        document.getElementById("repeatAudio").onclick = () => playSnippet(true);

        // MIT VIDEO → komplett durch
        document.getElementById("repeatVideo").onclick = () => playSnippet(false);

        document.getElementById("giveUp").onclick = () => {
            if (timeoutId) clearTimeout(timeoutId);
            overlay.style.display = 'none';
            player.loadVideoById({ videoId: videoId, startSeconds: startSec });
            player.playVideo();
            document.getElementById("feedback").innerHTML = `Aufgegeben! Es war:<br><b>${currentTitle}</b>`;
            document.getElementById("nextButton").classList.remove("hide");
            document.querySelectorAll("#repeatAudio,#repeatVideo,#giveUp").forEach(b => b.classList.add("hide"));
        };

        document.getElementById("nextButton").onclick = neueRunde;
    </script>
</body>
</html>
